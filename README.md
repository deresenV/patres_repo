# patres_repo

### Инструкция для запуска
- python 3.12
 - Установить зависимости из requirements.txt
 - Вызвать uvicorn app.main:app из папки проекта
### Инструкция создания первого пользователя
- Перейти по адрессу http://localhost:8000/docs
- В эндпоинте POST auth/register ввести данные пользователя

### Описание структуры
#### app - основная директория проекта
- main.py - точка создания приложения
- config.py - конфигурация приложения (В данном случае расположил в нем ключ для jwt)

#### db - директория работы с базой данных
- models - sqlalchemy models tables
- schemas - pydantic valid schemas
- crud - crud операции над книгами и читателями + создание библиотекарей
- database.py - настройки бдшки

#### routers директория роутеров(По названиям какой к чему относится видно)
#### services - бизнес логика
#### methods - функции для работы приложения(Токен, хэширование пароля)

### Структура БД
Структура бд разбита на 4 основные таблицы(Библиотекарь/user, книги, читатель, взятые книги)
Считаю такую структуру оптимальной

### Описание 4.1-4.3
#### **Сложности**: 
- Подход к проверке, согласованность данных(>=0) (лично для меня было неизвестно, ранее не было нужды заниматься таким)
- Проверка кол-ва книг у читателя(Не смог реализовать такой-же подход как с кол-вом книг, что-то пошло не так и по кругу ходил чинил сломанность таблицы потом) В итоге принял решение непосредственно в функции бизнес логики проверять кол-во книг у читателя

#### **Бизнес логика**: 
Взятие:
- Проверяет существует ли такая книга и читатель
- Проверяет доступность экземпляра и кол-во книг у читателя
- Проверка не взята ли уже книга
- Уменьшение кол-ва книг и создание записи о взятой книге

Отдать книгу:
- Проверка книги и пользователя
- Проверка записи о взятой книге
- Увеличивает кол-во книг
- Обновляет запись о выдаче проставляя временную метку

Список книг у читателя:
- Проверка существует ли читатель
- Есть ли взятые книги?
- Проверяет что поле с датой возврата пустое и в таком случае показывает запись


### Эндпоинт библиотеки(Всех книг)
Если предположить что наша библиотека - коммерческий продукт, то для пользователя должны быть видны существующие книги в ней, так пользователь может заинтересоваться книгой, которая есть в наличии и приобрести подписку. 
Следуя такой логике эндпоинт библиотеки остался открытым и не требует авторизации

### Защита эндпоинтов
Используется JWT
Пароли хранятся в хэшированном виде
Токены имеют время жинзни
Создается токен с email в sub'e 
Токен подписывается ключом
Используется проверка токена через get_current_user, где происходит проверка валидности токена
Эндпоинты защищены через проверку валидности токена(Используется 0Auth2PB), проверяя валидность токена через depends в самом начале
Защищены все эндпоинты которые были прописаны как защищенные в ТЗ
 #### Библиотеки для jwt
 - python-jose - работа с jwt
 - bcrypt - хэширование


 ### Идея
 Реализовать привычную систему рейтинга книги
 Либо просто добавить возможную систему оставить оценку книге, либо новую таблицу связную с книгой и пользователем + поля под рейтинг и отзыв
 Реализовать парочку эндпоинтов для читателей с возможностью оставить отзыв, посмотреть свои отзывы, обновить отзыв и удалить отзыв

Правила:
- Только бравший книгу может оставить отзыв
- 1 отзыв от читателя на одну книгу





